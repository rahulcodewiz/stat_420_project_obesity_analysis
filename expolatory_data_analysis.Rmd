---
title: "Obesity Analysis"
author: "Rahul Sharma"
date: ''
geometry: margin=2cm
output:
  html_document: 
    theme: readable
    toc: yes
  pdf_document: default

urlcolor: cyan
link-citations: yes
---
```{css, echo=FALSE}
h1,h3 {
  text-align: center;
}
```

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80, fig.align = "center")
knitr::opts_chunk$set(echo = TRUE)
library(RWeka)
library(knitr)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(viridis)
library(hrbrthemes)
library(lmtest)
```

***

## Load dataset
```{r}
obesity=read.arff("data/Obesity.arff"); 
obesity$NCP=as.factor(as.integer(obesity$NCP))
dim(obesity)
```

```{r}
summary(obesity)
```


```{r}
pairs(obesity)
```
```{r}
str(obesity)
```

***

## Variables exploration

### Data distribution by Age, Gender and Mode of transportation

```{r warning=FALSE}
obesity=obesity%>%mutate(ageBins = cut(Age, breaks = seq(0,100,by=10)))
p1=ggplot(obesity, aes(fill=Gender, y=Age, x=ageBins)) + 
    geom_bar(position="dodge", stat="identity")

p2=ggplot(obesity, aes(fill=MTRANS,y=Age, x=ageBins)) + 
    geom_bar(position="stack", stat="identity") +
    scale_fill_viridis(discrete = T) +
    theme_ipsum() +
    xlab("")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p1,p2,nrow=2,ncol=1)
```

Attributes related with eating habits analysis:

- Frequent consumption of high caloric food (FAVC)

- Frequency of consumption of vegetables (FCVC)

- Number of main meals (NCP)

- Consumption of food between meals (CAEC)

- Consumption of water daily (CH20)

- Consumption of alcohol (CALC)

```{r}
p1 = ggboxplot(obesity, x = "family_history_with_overweight", y = "Weight",
    color = "family_history_with_overweight", palette = "jco")

p2 = ggboxplot(obesity, x = "Gender", y = "Weight",
    color = "Gender", palette = "jco")
p3=ggboxplot(obesity, x = "MTRANS", y = "Weight",
    color = "MTRANS", palette = "jco")
p4=ggboxplot(obesity, x = "FAVC", y = "Weight",
    color = "FAVC", palette = "jco")+
    xlab("FAVC")
p5=ggboxplot(obesity, x = "NCP", y = "Weight",
    color = "NCP", palette = "jco")+
    xlab("NCP")
p6=ggboxplot(obesity, x = "CAEC", y = "Weight",
    color = "CAEC", palette = "jco")+
    xlab("CAEC")
p7=ggboxplot(obesity, x = "SMOKE", y = "Weight",
    color = "SMOKE", palette = "jco")+
    xlab("SMOKE")
ggarrange(p1,p2,p3,nrow=3,ncol=1)
```

```{r}
ggarrange(p4,p5,p6,p7,nrow=2,ncol=2)
```


```{r}

```

```{r}
p1=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Height, y = Weight,color=Gender))
p2=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Weight, y = Age,color=Gender))
p3=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Height, y = Age,color=Gender))
ggarrange(p1,p2,p3,nrow=3,ncol=1)
```


```{r eval=FALSE}
ggplot(obesity, aes(x=Age, color=Gender)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") 
```

```{r}
p1=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Height, y = Weight,color=NCP))
p2=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Height, y = Weight,color=SMOKE))
p3=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Height, y = Weight,color=FAVC))
p4=ggplot(data = obesity) +
  geom_point(mapping = aes(x = Height, y = Weight,color=MTRANS))
ggarrange(p1,p2,p3,p4,nrow=4,ncol=1)
```

Attributes related with the physical condition are:

- Calories consumption monitoring (SCC)

- Physical activity frequency (FAF)

- Time using technology devices (TUE)

```{r}
ggboxplot(obesity, x = "SCC", y = "Weight",
    color = "SCC", palette = "jco")
```

***

## Model Diagnostics

### Relevant variables full model



```{r}
plot_diagnostics=function (model){
  par(mfrow = c(2, 2))
  title=paste("Data from model: \n",summary(model)$call[2], summary(model)$call[3])
  plot(fitted(model), resid(model),pch = 20,  cex.main=1,cex.lab=1,xlab = "Fitted", ylab = "Residuals", main=title)
  abline(h = 0, lty = 2, lwd = 2)
  qqnorm(resid(obs_mod), main = "Normal Q-Q Plot", col = "darkgrey") 
  qqline(resid(obs_mod), col = "dodgerblue", lwd = 2)
  hist(resid(obs_mod),
       xlab   = "Residuals",
       main   = "Histogram of Residuals",
       col    = "darkorange",
       border = "dodgerblue",
       breaks = 20)
}

mod_performance=function(obs_mod,obs_tst,obs_trn){
  smry=summary(obs_mod)
  #Train RMSE
  trn_rmse=sqrt(mean(resid(obs_mod)^2))
  pred=predict(obs_mod,newdata=obs_tst)
  #Train RMSE
  tst_rmse=sqrt(mean((obs_tst$Weight-pred)^2))
  list(r2=smry$r.squared
       ,adjr2=smry$adj.r.squared,
       trn_rmse=trn_rmse,tst_rmse=tst_rmse,
       bptest=bptest(obs_mod)$p.value
       ,sptest=shapiro.test(resid(obs_mod))$p.value)
  
}
```

### Split dataset test and train

```{r}
set.seed(04082021)
## 75% of the sample size
smp_size <- floor(0.75 * nrow(obesity))
## set the seed to make your partition reproducible
trn_ind <- sample(seq_len(nrow(obesity)), size = smp_size)
obs_trn <- obesity[trn_ind, ]
obs_test <- obesity[-trn_ind, ]
obs_mod=lm(Weight~.,data=obs_trn)
summary(obs_mod)
```
### Fitted vs residual
```{r}
plot_diagnostics(obs_mod)
mod_performance()
```


### Unusual records using cook's distance

```{r}
sum(cooks.distance(obs_mod)>4/nrow(obs_mod))
```

### Equal variance-

```{r warning=FALSE, include=FALSE}
library(lmtest)
bptest(obs_mod)
```
Normality test fails

### Constant variance test using Sapiro

```{r}
shapiro.test(resid(obs_mod))
```

### Unusual observations hatvalues

```{r}
htval=hatvalues(obs_mod)
sum(htval > 2 * mean(htval))
```


### Points of large leverage- rstandard


```{r}
sum(abs(rstandard(obs_mod)) > 2)
```


```{r}
coefficients(summary(obs_mod))[3,"Pr(>|t|)"]
```

```{r}


```


